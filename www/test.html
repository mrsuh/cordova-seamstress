<!DOCTYPE html>
<html>
<head>
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport"
          content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <link rel="stylesheet" type="text/css" href="css/common.css">
    <title>Seamstress</title>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"/>

</head>
<body>

<div style="display: none">
    <select id="show_number_type_select" class="number_type">
        <option>0</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
    </select>
    <input id="show_number_type_checkbox" type="checkbox" class="number_type">
</div>

<!-- slide main-->
<div id="slide_main">
    <div class="header">
        <img id="settings_icon" src="img/settings.svg">
    </div>

    <div class="base">
        <span>Цена основы</span>
        <input id="pay_base" type="text">
    </div>

    <table id="show_table">
        <colgroup>
            <col class="name">
            <col class="pay">
            <col class="number">
        </colgroup>

        <thead>
        <tr>
            <th class="name">Наименование</th>
            <th>Цена</th>
            <th>Кол-во</th>
        </tr>
        </thead>

        <tbody>
        </tbody>

    </table>
    <div id="pay_result"></div>

</div>

<!-- slide settings-->
<div id="slide_settings">

    <div class="header">
        <img id="home_icon" src="img/home.svg">
    </div>

    <table id="table">
        <colgroup>
            <col class="name">
            <col class="pay_type">
            <col class="pay_value">
            <col class="number_type">
            <col class="delete">
        </colgroup>
        <thead>
        <tr>
            <th>имя</th>
            <th>цена</th>
            <th>знач.</th>
            <th>кол-во</th>
            <th>уд.</th>
        </tr>
        </thead>

        <tbody>
        <tr id="tr" data-type="template">
            <td>
                <input type="text" class="name">
            </td>
            <td>
                <select class="pay_type">
                    <option value="1">%</option>
                    <option value="2">ед.</option>
                </select>
            </td>
            <td>
                <input type="text" class="pay_value" value="0">
            </td>
            <td>
                <select class="number_type">
                    <option value="1">1</option>
                    <option value="2">неск.</option>
                </select>
            </td>
            <td>
                <button type="button" class="delete">X</button>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="buttons">

        <button type="button" id="btn_save_fields">сохранить</button>
    </div>

    <button type="button" id="btn_add_field">+</button>

</div>

<script>

    var showFields = function () {
        var show_table = document.querySelector('#show_table tbody');

        while (show_table.firstChild) {
            show_table.removeChild(show_table.firstChild);
        }

        var select = document.getElementById('show_number_type_select');
        var checkbox = document.getElementById('show_number_type_checkbox');
        for (var key in localStorage) {
            var data = JSON.parse(localStorage[key]);
            var show_tr = document.createElement('tr');

            var show_td_name = document.createElement('td');
            show_td_name.className = 'name';
            show_td_name.innerText = data.name;

            var show_td_pay = document.createElement('td');
            show_td_pay.className = 'pay';
            show_td_pay.setAttribute('data-type', data.pay_type);
            show_td_pay.setAttribute('data-value', data.pay_value);

            var show_td_number = document.createElement('td');
            show_td_number.className = 'number';
            show_td_number.setAttribute('data-type', data.number_type);

            var show_number_type = null;
            if (data.number_type === 1) {
                show_number_type = checkbox.cloneNode(true);
            } else {
                show_number_type = select.cloneNode(true);
            }
            show_number_type.removeAttribute('id');
            show_number_type.onchange = function () {
                remath();
            };

            show_td_number.appendChild(show_number_type);

            show_tr.appendChild(show_td_name);
            show_tr.appendChild(show_td_pay);
            show_tr.appendChild(show_td_number);

            show_table.appendChild(show_tr);
        }
    };

    var goToSettings = function () {
        document.getElementById('slide_main').style.display = 'none';
        document.getElementById('slide_settings').style.display = 'block';
    };

    var goToHome = function () {
        showFields();
        document.getElementById('slide_main').style.display = 'block';
        document.getElementById('slide_settings').style.display = 'none';
    };

    goToHome();

    var bindDelete = function (elem) {
        elem.onclick = function (e) {
            e.target.parentNode.parentNode.remove();
        }
    };

    document.getElementById('settings_icon').onclick = goToSettings;
    document.getElementById('home_icon').onclick = goToHome;

    var tr = document.getElementById('tr');
    var table = document.querySelector('#table tbody');
    for (var key in localStorage) {
        var data = JSON.parse(localStorage[key]);
        var tr_clone = tr.cloneNode(true);
        tr_clone.removeAttribute('id');
        tr_clone.removeAttribute('data-type');
        tr_clone.querySelector('.name').value = data.name;
        tr_clone.querySelector('.pay_type').value = data.pay_type;
        tr_clone.querySelector('.pay_value').value = data.pay_value;
        tr_clone.querySelector('.number_type').value = data.number_type;
        bindDelete(tr_clone.querySelector('.delete'));
        table.appendChild(tr_clone);
    }

    document.getElementById('btn_add_field').onclick = function () {
        var tr = document.getElementById('tr');
        var cln = tr.cloneNode(true);
        cln.removeAttribute('id');
        cln.removeAttribute('data-type');
        bindDelete(cln.querySelector('.delete'));
        document.querySelector('#table tbody').appendChild(cln);
    };

    document.getElementById('btn_save_fields').onclick = function () {
        var fields = document.querySelectorAll('#table tbody tr');
        localStorage.clear();
        var length = fields.length;
        for (var i = 0; i < length; i++) {
            console.info(fields[i].style.display);
            if (fields[i].getAttribute('data-type') === 'template') {
                continue;
            }
            localStorage.setItem(i.toString(), JSON.stringify({
                name: fields[i].querySelector('.name').value,
                pay_type: parseInt(fields[i].querySelector('.pay_type').value),
                pay_value: parseFloat(fields[i].querySelector('.pay_value').value),
                number_type: parseInt(fields[i].querySelector('.number_type').value)
            }));
        }
        goToHome();
    };

    var remath = function () {
        console.info('remath 2');
        var pay_base = parseFloat(document.getElementById('pay_base').value);

        console.info(pay_base);
        if (0 === pay_base || isNaN(pay_base)) {
            console.info('invalid base');
            return false;
        }
        var fields = document.querySelectorAll('#show_table tbody tr');
        var result = pay_base;
        var length = fields.length;

        for (var i = 0; i < length; i++) {

            var pay_type = parseInt(fields[i].querySelector('.pay').getAttribute('data-type'));
            var pay_number = parseFloat(fields[i].querySelector('.pay').getAttribute('data-value'));
            var number_type = parseInt(fields[i].querySelector('.number').getAttribute('data-type'));

            var number = null;
            if (number_type === 1) {
                number = fields[i].querySelector('.number .number_type').checked ? 1 : 0;
            } else {
                number = fields[i].querySelector('.number .number_type').value;
            }

            var pay_add = 0;
            if (pay_type === 1) {
                pay_add += pay_base * (pay_number / 100) * number;
            } else {
                pay_add += pay_number * number;
            }

            fields[i].querySelector('.pay').innerText = pay_add.toFixed(2);
            result += pay_add;
        }

        document.getElementById('pay_result').innerText = result.toFixed(2);
    };

    document.getElementById('pay_base').oninput = function () {
        remath();
    };


</script>
</body>
</html>
